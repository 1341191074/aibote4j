# é”™è¯¯è¯Šæ–­

æœ¬ç« è¯¦ç»†ä»‹ç»å¦‚ä½•è¯Šæ–­å’Œè§£å†³ Aibote4J æ¡†æ¶ä¸­çš„å„ç±»é”™è¯¯ã€‚

## ğŸ” è¯Šæ–­å·¥å…·å’Œæ–¹æ³•

### 1. æ—¥å¿—åˆ†æ

#### å¯ç”¨è¯¦ç»†æ—¥å¿—

```yaml
# logback.xml
<configuration>
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- è°ƒè¯•çº§åˆ« -->
    <logger name="net.aibote" level="DEBUG"/>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>
```

#### æ—¥å¿—çº§åˆ«è¯´æ˜

| æ—¥å¿—çº§åˆ« | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|---------|------|----------|
| ERROR | é”™è¯¯ä¿¡æ¯ | ç¨‹åºå¼‚å¸¸å’Œé”™è¯¯ |
| WARN | è­¦å‘Šä¿¡æ¯ | æ½œåœ¨é—®é¢˜ |
| INFO | ä¸€èˆ¬ä¿¡æ¯ | é‡è¦æ“ä½œè®°å½• |
| DEBUG | è°ƒè¯•ä¿¡æ¯ | è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹ |

### 2. ä½¿ç”¨ Correlation ID è¿›è¡Œè¿½è¸ª

```java
// è·å– Correlation ID
String correlationId = RequestTraceHandler.getInstance()
    .getOrCreateCorrelationId();

// åœ¨æ—¥å¿—ä¸­åŒ…å« Correlation ID
log.info("[{}] Starting operation", correlationId);

// æ£€æŸ¥è¯·æ±‚æ‰§è¡Œæ—¶é—´
RequestTraceHandler.RequestMetadata metadata = RequestTraceHandler
    .getInstance()
    .getRequestMetadata(correlationId);

if (metadata != null) {
    log.info("Request duration: {}ms", metadata.getDurationMillis());
}
```

## ğŸ› ï¸ å¸¸è§é”™è¯¯ç±»å‹åŠè¯Šæ–­

### 1. è¿æ¥é”™è¯¯è¯Šæ–­

#### è¿æ¥å¤±è´¥è¯Šæ–­

```java
// è¯¦ç»†è¯Šæ–­è¿æ¥é—®é¢˜
try {
    WinBot bot = BotFactory.builder()
        .withBotType(BotFactory.BotType.WIN)
        .withIP("127.0.0.1")
        .withPort(9527)
        .build();
    
    log.info("Registering diagnostic task");
    
    NotepadAutomationTask diagnosticTask = NotepadAutomationTask.builder()
        .taskName("è¯Šæ–­ä»»åŠ¡")
        .scriptName("Diagnostic-Task")
        .build();
    
    String taskId = TaskEngine.getInstance().registerTask("diagnostic-task", diagnosticTask);
    if (taskId != null) {
        log.info("Diagnostic task registered successfully: {}", taskId);
        
        // æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
        try {
            InetAddress addr = InetAddress.getByName("127.0.0.1");
            boolean reachable = addr.isReachable(5000); // 5ç§’è¶…æ—¶
            log.info("Host reachable: {}", reachable);
        } catch (IOException e) {
            log.error("Network check failed: {}", e.getMessage());
        }
    } else {
        log.info("Successfully connected to bot");
    }
} catch (Exception e) {
    log.error("Connection attempt failed with exception: ", e);
}
```

#### è¿æ¥è¶…æ—¶è¯Šæ–­

```java
// è¯Šæ–­è¶…æ—¶é—®é¢˜
ConfigManager configManager = ConfigManager.getInstance();
long timeout = configManager.getCommunicationConfig().getResponseTimeout();
log.info("Current response timeout: {}ms", timeout);

// å°è¯•å¢åŠ è¶…æ—¶æ—¶é—´
configManager.getCommunicationConfig().setResponseTimeout(30000); // 30ç§’
log.info("Updated response timeout to: {}ms", 30000);
```

### 2. å‘½ä»¤æ‰§è¡Œé”™è¯¯è¯Šæ–­

#### é€šç”¨å‘½ä»¤é”™è¯¯è¯Šæ–­

```java
public void diagnoseCommandExecution(AbstractPlatformBot bot) {
    String correlationId = RequestTraceHandler.getInstance()
        .getOrCreateCorrelationId();
    
    try {
        log.info("[{}] Starting command execution diagnosis", correlationId);
        
        // æ‰§è¡Œè¯Šæ–­å‘½ä»¤
        String result = bot.getWindowSize(); // æˆ–å…¶ä»–ç®€å•çš„å‘½ä»¤
        
        if (result != null) {
            log.info("[{}] Command executed successfully: {}", correlationId, result);
        } else {
            log.warn("[{}] Command returned null result", correlationId);
        }
    } catch (CommandException e) {
        log.error("[{}] Command execution failed: {}", correlationId, e.getErrorMessage());
        log.error("[{}] Error code: {}", correlationId, e.getErrCode());
    } catch (TimeoutException e) {
        log.error("[{}] Command timed out: {}", correlationId, e.getErrorMessage());
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé—®é¢˜
        diagnoseNetworkIssue();
    } catch (Exception e) {
        log.error("[{}] Unexpected error during command execution", correlationId, e);
    } finally {
        RequestTraceHandler.getInstance()
            .markRequestComplete(correlationId);
    }
}
```

#### å›¾åƒè¯†åˆ«é”™è¯¯è¯Šæ–­

```java
public void diagnoseImageRecognition(AndroidBot bot, String imagePath) {
    String correlationId = RequestTraceHandler.getInstance()
        .getOrCreateCorrelationId();
    
    try {
        log.info("[{}] Starting image recognition diagnosis for: {}", correlationId, imagePath);
        
        // æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        File imageFile = new File(imagePath);
        if (!imageFile.exists()) {
            log.error("[{}] Image file does not exist: {}", correlationId, imagePath);
            return;
        }
        
        log.info("[{}] Image file size: {} bytes", correlationId, imageFile.length());
        
        // å°è¯•ä¸åŒç›¸ä¼¼åº¦è¿›è¡Œè¯†åˆ«
        float[] similarities = {0.9f, 0.8f, 0.7f, 0.6f};
        for (float sim : similarities) {
            Point result = bot.findImage(imagePath, sim);
            if (result != null) {
                log.info("[{}] Found image at ({}, {}) with similarity {}", 
                         correlationId, result.x, result.y, sim);
                break;
            } else {
                log.info("[{}] Image not found with similarity {}", correlationId, sim);
            }
        }
    } catch (Exception e) {
        log.error("[{}] Image recognition diagnosis failed", correlationId, e);
    } finally {
        RequestTraceHandler.getInstance()
            .markRequestComplete(correlationId);
    }
}
```

### 3. OCR è¯†åˆ«é”™è¯¯è¯Šæ–­

```java
public void diagnoseOCR(AndroidBot bot) {
    String correlationId = RequestTraceHandler.getInstance()
        .getOrCreateCorrelationId();
    
    try {
        log.info("[{}] Starting OCR diagnosis", correlationId);
        
        // æ£€æŸ¥ OCR æœåŠ¡æ˜¯å¦åˆå§‹åŒ–
        // å¯ä»¥å°è¯•æ‰§è¡Œä¸€ä¸ªç®€å•çš„ OCR æ“ä½œ
        Region region = new Region(0, 0, 100, 100); // å°åŒºåŸŸæµ‹è¯•
        
        List<OCRResult> results = bot.ocr(region, 0, 0, 0, 1.0f);
        
        if (results != null && !results.isEmpty()) {
            log.info("[{}] OCR test successful, found {} text elements", 
                     correlationId, results.size());
            
            // è¾“å‡ºå‰å‡ ä¸ªè¯†åˆ«ç»“æœ
            for (int i = 0; i < Math.min(3, results.size()); i++) {
                OCRResult result = results.get(i);
                log.info("[{}] OCR result {}: '{}' (confidence: {})", 
                         correlationId, i, result.word, result.rate);
            }
        } else {
            log.warn("[{}] OCR test returned no results", correlationId);
        }
    } catch (Exception e) {
        log.error("[{}] OCR diagnosis failed", correlationId, e);
        
        // æ£€æŸ¥ OCR æœåŠ¡çŠ¶æ€
        checkOCRServiceStatus();
    } finally {
        RequestTraceHandler.getInstance()
            .markRequestComplete(correlationId);
    }
}
```

## ğŸ§ª è°ƒè¯•æŠ€å·§

### 1. é€æ­¥è°ƒè¯•æ³•

```java
public void stepByStepDebugging(AndroidBot bot) {
    String correlationId = RequestTraceHandler.getInstance()
        .getOrCreateCorrelationId();
    
    try {
        log.info("[{}] Starting step-by-step debugging", correlationId);
        
        // æ­¥éª¤ 1: æ£€æŸ¥è¿æ¥
        log.info("[{}] Step 1: Verifying connection...", correlationId);
        if (bot.getAndroidId() != null) {
            log.info("[{}] Step 1: Connection OK", correlationId);
        } else {
            log.error("[{}] Step 1: Connection FAILED", correlationId);
            return;
        }
        
        // æ­¥éª¤ 2: æ£€æŸ¥å±å¹•å°ºå¯¸
        log.info("[{}] Step 2: Getting screen size...", correlationId);
        String screenSize = bot.getWindowSize();
        if (screenSize != null && !screenSize.isEmpty()) {
            log.info("[{}] Step 2: Screen size: {}", correlationId, screenSize);
        } else {
            log.error("[{}] Step 2: Failed to get screen size", correlationId);
            return;
        }
        
        // æ­¥éª¤ 3: å°è¯•åŸºæœ¬æ“ä½œ
        log.info("[{}] Step 3: Testing basic operation...", correlationId);
        boolean clickResult = bot.click(100, 100);
        log.info("[{}] Step 3: Click test result: {}", correlationId, clickResult);
        
        log.info("[{}] All steps completed successfully", correlationId);
    } finally {
        RequestTraceHandler.getInstance()
            .markRequestComplete(correlationId);
    }
}
```

### 2. é…ç½®éªŒè¯

```java
public void validateConfiguration() {
    ConfigManager configManager = ConfigManager.getInstance();
    CommunicationConfig commConfig = configManager.getCommunicationConfig();
    
    log.info("=== Configuration Validation ===");
    log.info("Response timeout: {}ms", commConfig.getResponseTimeout());
    log.info("Delay response timeout: {}ms", commConfig.getDelayResponseTimeout());
    log.info("Retry times: {}", commConfig.getRetryTimes());
    log.info("Retry interval: {}ms", commConfig.getRetryInterval());
    log.info("Connection pool size: {}", commConfig.getConnectionPoolSize());
    
    PerformanceConfig perfConfig = configManager.getPerformanceConfig();
    log.info("Max concurrency: {}", perfConfig.getMaxConcurrency());
    log.info("Thread pool size: {}", perfConfig.getThreadPoolSize());
    
    log.info("===============================");
}
```

### 3. ç¯å¢ƒæ£€æŸ¥

```java
public void checkEnvironment() {
    log.info("=== Environment Check ===");
    
    // Java ç‰ˆæœ¬
    String javaVersion = System.getProperty("java.version");
    String javaHome = System.getProperty("java.home");
    log.info("Java Version: {}", javaVersion);
    log.info("Java Home: {}", javaHome);
    
    // æ“ä½œç³»ç»Ÿ
    String osName = System.getProperty("os.name");
    String osVersion = System.getProperty("os.version");
    String osArch = System.getProperty("os.arch");
    log.info("OS: {} {} {}", osName, osVersion, osArch);
    
    // å†…å­˜ä½¿ç”¨æƒ…å†µ
    Runtime runtime = Runtime.getRuntime();
    long maxMemory = runtime.maxMemory();
    long totalMemory = runtime.totalMemory();
    long freeMemory = runtime.freeMemory();
    long usedMemory = totalMemory - freeMemory;
    
    log.info("Max Memory: {} MB", maxMemory / 1024 / 1024);
    log.info("Total Memory: {} MB", totalMemory / 1024 / 1024);
    log.info("Used Memory: {} MB", usedMemory / 1024 / 1024);
    log.info("Free Memory: {} MB", freeMemory / 1024 / 1024);
    
    log.info("========================");
}
```

## ğŸ”§ ä¿®å¤ç­–ç•¥

### 1. è‡ªåŠ¨é‡è¯•æœºåˆ¶

```java
public <T> T executeWithRetry(Supplier<T> operation, int maxRetries, long retryDelayMs) {
    int attempt = 0;
    Exception lastException = null;
    
    while (attempt < maxRetries) {
        try {
            T result = operation.get();
            if (result != null) {
                log.info("Operation succeeded on attempt {}", attempt + 1);
                return result;
            }
        } catch (Exception e) {
            lastException = e;
            log.warn("Attempt {} failed: {}", attempt + 1, e.getMessage());
        }
        
        attempt++;
        if (attempt < maxRetries) {
            try {
                Thread.sleep(retryDelayMs);
            } catch (InterruptedException ie) {
                Thread.currentThread().interrupt();
                throw new RuntimeException("Retry interrupted", ie);
            }
        }
    }
    
    throw new RuntimeException(
        String.format("Operation failed after %d attempts", maxRetries), 
        lastException
    );
}
```

### 2. é™çº§ç­–ç•¥

```java
public void executeWithFallback(AbstractPlatformBot bot) {
    try {
        // é¦–é€‰æ–¹æ³•
        log.info("Trying primary method...");
        executePrimaryMethod(bot);
    } catch (Exception primaryError) {
        log.warn("Primary method failed, trying fallback: {}", primaryError.getMessage());
        
        try {
            // é™çº§æ–¹æ³•
            executeFallbackMethod(bot);
            log.info("Fallback method succeeded");
        } catch (Exception fallbackError) {
            log.error("Both primary and fallback methods failed");
            log.error("Primary error: ", primaryError);
            log.error("Fallback error: ", fallbackError);
            throw new RuntimeException("All methods failed", primaryError);
        }
    }
}
```

### 3. ç†”æ–­æœºåˆ¶

```java
public class CircuitBreaker {
    private int failureCount = 0;
    private long lastFailureTime = 0;
    private static final int FAILURE_THRESHOLD = 5;
    private static final long RESET_TIMEOUT = 60000; // 1 minute
    
    public boolean canExecute() {
        if (failureCount >= FAILURE_THRESHOLD) {
            long now = System.currentTimeMillis();
            if (now - lastFailureTime > RESET_TIMEOUT) {
                // å°è¯•é‡ç½®ï¼šå…è®¸ä¸€æ¬¡æ‰§è¡Œæ¥æµ‹è¯•
                return true;
            }
            return false; // ä»ç„¶ç†”æ–­
        }
        return true; // æ­£å¸¸çŠ¶æ€
    }
    
    public void onSuccess() {
        failureCount = 0;
    }
    
    public void onFailure() {
        failureCount++;
        lastFailureTime = System.currentTimeMillis();
    }
}
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### 1. æ€§èƒ½ç›‘æ§

```java
public void monitorPerformance() {
    RequestTraceHandler traceHandler = RequestTraceHandler.getInstance();
    ResponseCacheHandler cacheHandler = ResponseCacheHandler.getInstance();
    
    // è¯·æ±‚ç»Ÿè®¡
    long totalRequests = traceHandler.getTotalRequestCount();
    log.info("Total requests processed: {}", totalRequests);
    
    // ç¼“å­˜ç»Ÿè®¡
    int cacheSize = cacheHandler.getCacheSize();
    log.info("Current cache size: {}", cacheSize);
    
    // è¿æ¥æ± ç»Ÿè®¡
    ConnectionPoolManager poolManager = ConnectionPoolManager.getInstance();
    int activeConnections = poolManager.getActiveConnections();
    int idleConnections = poolManager.getIdleConnections();
    log.info("Active connections: {}, Idle connections: {}", 
             activeConnections, idleConnections);
}
```

### 2. é”™è¯¯ç‡ç›‘æ§

```java
public class ErrorRateMonitor {
    private AtomicInteger errorCount = new AtomicInteger(0);
    private AtomicInteger totalCount = new AtomicInteger(0);
    private long monitoringPeriodStart = System.currentTimeMillis();
    private static final long MONITORING_PERIOD = 60000; // 1 minute
    
    public void recordSuccess() {
        totalCount.incrementAndGet();
    }
    
    public void recordError() {
        totalCount.incrementAndGet();
        errorCount.incrementAndGet();
    }
    
    public double getErrorRate() {
        int total = totalCount.get();
        if (total == 0) return 0.0;
        
        long currentTime = System.currentTimeMillis();
        if (currentTime - monitoringPeriodStart > MONITORING_PERIOD) {
            // é‡ç½®ç»Ÿè®¡ï¼ˆå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„æ»šåŠ¨çª—å£ï¼‰
            reset();
            return 0.0;
        }
        
        return (double) errorCount.get() / total * 100.0;
    }
    
    private void reset() {
        errorCount.set(0);
        totalCount.set(0);
        monitoringPeriodStart = System.currentTimeMillis();
    }
}
```